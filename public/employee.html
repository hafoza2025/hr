<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± - Ù…ÙˆØ¨Ø§ÙŠÙ„</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
    <div class="container">
        <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙ -->
        <div class="id-card" id="idCard" style="display: none;">
            <div class="logo">
                <img id="companyLogo" src="/uploads/logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©">
            </div>

            <div class="employee-info">
                <h3 id="companyName">...</h3>
                <h2 id="employeeName">...</h2>
                <p id="employeeDepartment">...</p>
                <div class="employee-code" id="employeeCode">...</div>
            </div>

            <div class="qr-code" id="qrcode"></div>
        </div>

        <!-- Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…Ø³Ø¬Ù„ -->
        <div id="notRegistered" class="section-card" style="display: none; text-align: center;">
            <h2 style="color: #dc3545;">âŒ IP ØºÙŠØ± Ù…Ø³Ø¬Ù„</h2>
            <p style="margin: 20px 0; color: #666;">
                Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….
            </p>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 20px 0;">
                <p style="font-weight: bold;">IP Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</p>
                <p id="clientIP" style="font-size: 18px; color: #667eea; font-family: monospace;"></p>
            </div>
            <p style="color: #999; font-size: 14px;">
                Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ£Ø¹Ø·Ù‡ Ù‡Ø°Ø§ Ø§Ù„Ù€ IP Ù„Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨Ùƒ
            </p>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
        <div id="attendanceSection" class="action-section" style="display: none;">
            <div id="statusMessage" class="status-message status-info" style="display: none;"></div>

            <button id="attendanceBtn" class="btn">
                ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± / Ø§Ù†ØµØ±Ø§Ù
            </button>

            <div class="attendance-history" id="attendanceHistory"></div>
        </div>

        <!-- Loading -->
        <div id="loading" style="text-align: center; padding: 40px;">
            <div class="loading"></div>
            <p style="margin-top: 20px; color: #666;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„ÙŠÙƒ...</p>
        </div>
    </div>

    <script>
        let employeeData = null;
        let companyData = null;

        // Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('DOMContentLoaded', async () => {
            await autoDetectEmployee();
        });

        // Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¸Ù
        async function autoDetectEmployee() {
            try {
                const response = await fetch('/api/employee/auto-detect');
                const data = await response.json();

                document.getElementById('loading').style.display = 'none';

                if (data.detected) {
                    // Ù…ÙˆØ¸Ù Ù…Ø³Ø¬Ù„
                    employeeData = data.employee;
                    companyData = data.company;
                    showEmployeeCard();
                    await loadAttendanceHistory();
                } else {
                    // ØºÙŠØ± Ù…Ø³Ø¬Ù„
                    document.getElementById('notRegistered').style.display = 'block';
                    document.getElementById('clientIP').textContent = data.client_ip;
                }

            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error');
            }
        }

        // Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙˆØ¸Ù
        function showEmployeeCard() {
            document.getElementById('idCard').style.display = 'block';
            document.getElementById('attendanceSection').style.display = 'block';

            document.getElementById('companyName').textContent = companyData.name;
            document.getElementById('employeeName').textContent = employeeData.name;
            document.getElementById('employeeDepartment').textContent = `Ø§Ù„Ù‚Ø³Ù…: ${employeeData.department}`;
            document.getElementById('employeeCode').textContent = employeeData.employee_code;

            if (companyData.logo_url) {
                document.getElementById('companyLogo').src = companyData.logo_url;
            }

            if (companyData.brand_color) {
                document.getElementById('idCard').style.background =
                    `linear-gradient(135deg, ${companyData.brand_color} 0%, ${adjustColor(companyData.brand_color, -20)} 100%)`;
            }

            new QRCode(document.getElementById('qrcode'), {
                text: employeeData.employee_code,
                width: 128,
                height: 128
            });
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±/Ø§Ù„Ø§Ù†ØµØ±Ø§Ù
        document.getElementById('attendanceBtn').addEventListener('click', async () => {
            const btn = document.getElementById('attendanceBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';

            showMessage('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ...', 'info');

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude, accuracy } = position.coords;

                    try {
                        const response = await fetch('/api/attendance/auto', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                lat: latitude,
                                lng: longitude,
                                accuracy: Math.round(accuracy)
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            showMessage(
                                `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${data.action} Ø¨Ù†Ø¬Ø§Ø­!\n` +
                                `Ø§Ù„Ù…ÙˆØ¸Ù: ${data.employee_name}\n` +
                                `Ø§Ù„ÙƒÙˆØ¯: ${data.employee_code}\n` +
                                `Ø§Ù„ÙˆÙ‚Øª: ${new Date(data.time).toLocaleTimeString('ar-EG')}\n` +
                                `Ø§Ù„Ù…Ø³Ø§ÙØ©: ${data.distance} Ù…ØªØ±`,
                                'success'
                            );
                            await loadAttendanceHistory();
                        } else {
                            showMessage('âŒ ' + data.error, 'error');
                        }

                    } catch (error) {
                        showMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
                    }

                    btn.disabled = false;
                    btn.innerHTML = 'ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± / Ø§Ù†ØµØ±Ø§Ù';
                },
                (error) => {
                    showMessage('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
                    btn.disabled = false;
                    btn.innerHTML = 'ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± / Ø§Ù†ØµØ±Ø§Ù';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });

        // Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±
        async function loadAttendanceHistory() {
            if (!employeeData) return;

            try {
                const response = await fetch(`/api/employee/${employeeData.id}/attendance`);
                const records = await response.json();

                const historyDiv = document.getElementById('attendanceHistory');

                if (records.length === 0) {
                    historyDiv.innerHTML = '<p style="text-align: center; color: #999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø¨Ø¹Ø¯</p>';
                    return;
                }

                const recentRecords = records.slice(-10).reverse();

                historyDiv.innerHTML = '<h3 style="margin-bottom: 15px;">Ø¢Ø®Ø± Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h3>';

                recentRecords.forEach(record => {
                    const time = new Date(record.time);
                    const div = document.createElement('div');
                    div.className = `attendance-record record-${record.action}`;

                    div.innerHTML = `
            <div>
              <strong>${record.action === 'checkin' ? 'ğŸŸ¢ Ø­Ø¶ÙˆØ±' : 'ğŸ”´ Ø§Ù†ØµØ±Ø§Ù'}</strong>
              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                ${time.toLocaleDateString('ar-EG')}
              </div>
            </div>
            <div style="text-align: left;">
              <strong>${time.toLocaleTimeString('ar-EG')}</strong>
            </div>
          `;

                    historyDiv.appendChild(div);
                });

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„:', error);
            }
        }

        function showMessage(text, type) {
            const msgDiv = document.getElementById('statusMessage');
            msgDiv.textContent = text;
            msgDiv.className = `status-message status-${type}`;
            msgDiv.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => { msgDiv.style.display = 'none'; }, 5000);
            }
        }

        function adjustColor(color, amount) {
            const clamp = (val) => Math.min(Math.max(val, 0), 255);
            const num = parseInt(color.replace('#', ''), 16);
            const r = clamp((num >> 16) + amount);
            const g = clamp(((num >> 8) & 0x00FF) + amount);
            const b = clamp((num & 0x0000FF) + amount);
            return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }
    </script>
</body>

</html>